package RwTool.rwtool.services;

import RwTool.rwtool.entity.Report;
import RwTool.rwtool.entity.ReportType;
import RwTool.rwtool.entity.UserEntity;
import RwTool.rwtool.exception.ResourceNotFoundException;
import RwTool.rwtool.repo.ReportRepository;
import RwTool.rwtool.repo.ReportTypeRepository;
import RwTool.rwtool.repo.UserRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.time.LocalDateTime;
import java.util.Optional;

@Service
public class AdminFileService {

    private final ReportRepository reportRepository;
    private final ReportTypeRepository reportTypeRepository;
    private final UserRepository userRepository;
    private final FileStorageService fileStorageService;

    public AdminFileService(ReportRepository reportRepository, 
                            ReportTypeRepository reportTypeRepository, 
                            UserRepository userRepository, 
                            FileStorageService fileStorageService) {
        this.reportRepository = reportRepository;
        this.reportTypeRepository = reportTypeRepository;
        this.userRepository = userRepository;
        this.fileStorageService = fileStorageService;
    }

    @Transactional
    public Report intelligentUpload(MultipartFile file, Long uploaderId) {
        UserEntity uploader = userRepository.findById(uploaderId)
                .orElseThrow(() -> new ResourceNotFoundException("Uploader (Admin) not found with id: " + uploaderId));

        ReportType reportType = findOrCreateReportType(file.getOriginalFilename());

        String storedFilePath = fileStorageService.store(file, reportType);

        Report newReport = new Report();
        newReport.setFileName(file.getOriginalFilename());
        newReport.setReportType(reportType);
        newReport.setUploadedBy(uploader.getFullname());
        newReport.setFileStoragePath(storedFilePath);
        newReport.setGeneratedDate(LocalDateTime.now());

        return reportRepository.save(newReport);
    }

    private ReportType findOrCreateReportType(String fileName) {
        String parsedName = parseNameFromFileName(fileName);
        Optional<ReportType> existingType = reportTypeRepository.findByName(parsedName);

        return existingType.orElseGet(() -> {
            ReportType newType = new ReportType();
            newType.setName(parsedName);
            newType.setSourcePath(null);
            return reportTypeRepository.save(newType);
        });
    }

    private String parseNameFromFileName(String fileName) {
        String baseName = fileName;
        if (fileName.contains("_")) {
            baseName = fileName.substring(0, fileName.indexOf("_"));
        } else if (fileName.contains(".")) {
            baseName = fileName.substring(0, fileName.lastIndexOf('.'));
        }
        return baseName.replaceAll("[^a-zA-Z0-9\\s]", "").trim() + " Reports";
    }
}
