package RwTool.rwtool.controller;

import RwTool.rwtool.dto.ReportResponse;
import RwTool.rwtool.entity.Report;
import RwTool.rwtool.services.AdminFileService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

@RestController
@RequestMapping("/api/admin/files")
public class AdminFileController {
    private final AdminFileService adminFileService;
    public AdminFileController(AdminFileService s) { this.adminFileService = s; }

    @PostMapping("/upload")
    public ResponseEntity<ReportResponse> handleIntelligentUpload(
            @RequestParam("file") MultipartFile file, Authentication authentication) {
        Long uploaderId = Long.parseLong(authentication.getName());
        Report savedReport = adminFileService.intelligentUpload(file, uploaderId);
        ReportResponse responseDto = convertToDto(savedReport);
        return new ResponseEntity<>(responseDto, HttpStatus.CREATED);
    }

    private ReportResponse convertToDto(Report report) {
        return new ReportResponse(report.getReportId(), report.getFileName(), report.getFileStoragePath(), report.getGeneratedDate(), report.getUploadedBy());
    }
}
